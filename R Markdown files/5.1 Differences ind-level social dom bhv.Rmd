---
title: "5. Differences ind-level social dom bhv"
author: "Justin Varholick"
date: '2022-06-14'
output: html_document
---

```{r setup}
library(tidyverse)
library(readxl)

library(lubridate)
library(igraph)

library(ggplot2)
library(ggsci)
library(cowplot)
library(ggthemr)
library(stringr)

ggthemr('flat')
```
##Extract data from BORIS
1 Open project file in BORIS
2 Click the Observations Menu > Export Events > aggregated events
3 Select the observations you wish to export, then all subjects and all behaviors
4 Click YES for group events into one file
5 Save as .csv file
6 edit in excel 
  1. split by "_" delimiter into 6 columns
  2. remove "MVI" from data
  3. Check all dates are actual dates (remove "2020")
  4. check all hours are actual hours (replace pt1, and shift 21 and 12 which extend to next column)
  5. check that all columns have the correct data, delete the coder initials data

```{r import data}
adata <- read.csv("/Users/justinvarholick/Documents/GitHub/AcomysDominance_2022_Data_Results/Data/dominanceevents_MASTER_adj.csv", stringsAsFactors=TRUE)

#Fixing observation.id inconsistencies...
adata$Cage <- adata$Observation.id
adata$Subject <- gsub("Mouse ","", as.factor(adata$Subject))
adata$Date <- gsub("-Jan","01", adata$Date)
adata$Modifiers <- gsub("None", "3", adata$Modifiers)
adata$Date <- gsub("3001", "20200130", adata$Date)
adata$Date <- gsub("2901", "20200129", adata$Date)
adata$Date <- gsub("2801", "20200128", adata$Date)
adata$Date <- gsub("2301", "20200123", adata$Date)
adata$Date <- gsub("2201", "20200122", adata$Date)
adata$Date <- gsub("2101", "20200121", adata$Date)
adata$Date <- gsub("730", "20190730", adata$Date)
adata$Date <- gsub("731", "20190731", adata$Date)
adata$Date <- gsub("801", "20190801", adata$Date)
adata$Date <- gsub("806", "20190806", adata$Date)
adata$Date <- gsub("807", "20190807", adata$Date)
adata$Date <- gsub("808", "20190808", adata$Date)
adata$Date <- gsub("815", "20190815", adata$Date)
adata$Date <- gsub("816", "20190816", adata$Date)
adata$Date <- gsub("817", "20190817", adata$Date)
adata$Date <- gsub("2019020190731", "20190731", adata$Date)
adata$Date <- gsub("2019020190807", "20190807", adata$Date)
adata$Date <- gsub("916", "20200916", adata$Date)
adata$Date <- gsub("922", "20200922", adata$Date)
adata$Date <- gsub("923", "20200923", adata$Date)
adata$Date <- gsub("2020020200916", "20200916", adata$Date)
adata$Date <- gsub("2020020200922", "20200922", adata$Date)
adata$Date <- gsub("2020020200923", "20200923", adata$Date)

adata$Hour2 <- paste(adata$Hour, "00", sep=":")
adata$Date <- ymd(adata$Date)
adata$DateHour <- paste(adata$Date, adata$Hour2, sep=" ")
adata$DateHour <- as.POSIXct(adata$DateHour, tz="America/New_York")
adata$DateHour <- ymd_hms(adata$DateHour)

adata$Start..s. <- duration(adata$Start..s., "seconds")
adata$Stop..s. <- duration(adata$Stop..s., "seconds")

adata$Start <- (adata$DateHour + adata$Start..s.)
adata$Stop <- (adata$DateHour + adata$Stop..s.)

ag <- adata %>% 
  within(Opponent.1 <- paste(Cage, Subject, sep="-")) %>% 
  within(value <- paste("1")) %>% 
  select(Opponent.1, value, Date, Behavior, Behavioral.category, Modifiers, Cage, Week)

locations <- ag %>% 
  filter(Behavioral.category=="Location") %>% 
  filter(Behavior!="Shelter") %>% 
  filter(Behavior!="Food Hopper") %>% 
  filter(Behavior!="Cup") %>% 
  unite("Behavior2", Behavior, Modifiers, sep="-", remove=T) %>% 
  rename("Behavior"=Behavior2)

ag <- ag %>% 
  filter(Behavioral.category!="Location") %>% 
  select(Opponent.1, value, Date, Behavior, Behavioral.category, Cage, Week)
ag <- rbind(ag, locations)

#add independent variables
sex_id <- read_excel("/Users/justinvarholick/Documents/GitHub/AcomysDominance_2022_Data_Results/Data/AcomysDomRegen_Inventory.xlsx", sheet = "Sheet3")
sex_id$Cage <- as.factor(sex_id$Cage)
ag$Cage <- as.factor(ag$Cage)

ag <- left_join(ag, sex_id, by="Cage")

ind_ds <- read.csv("/Users/justinvarholick/Documents/GitHub/AcomysDominance_2022_Data_Results/Data/dscorebyanimal_edited.csv")
ind_ds$Cage <- as.factor(ind_ds$Cage)
ind_ds <- rename(ind_ds, "Opponent.1"=AnimalID)

ag <- left_join(ag, ind_ds, by=c("Opponent.1", "Cage"))
```


```{r plot sex effects}
#data organization
ag2 <- ag %>% 
  group_by(Cage, Opponent.1, Sex, dom_status_ds, Behavior) %>% 
  count(value)

zeromatrix <- ag %>%
  select(Opponent.1, Sex, Cage, dom_status_ds) %>% 
  unique() %>% 
  mutate(Chasing=0) %>% 
  mutate(Mounting=0) %>% 
  mutate(Attacking=0) %>% 
  mutate(Stealing=0) %>% 
  mutate(Fleeing=0) %>% 
  mutate(`Induced Flee`=0) %>%
  mutate(Freeze=0) %>% 
  mutate(Unseen=0) %>% 
  mutate(Inactive=0) %>% 
  mutate(`Top-Left`=0) %>% 
  mutate(`Top-Right`=0) %>% 
  mutate(`Bottom-Left`=0) %>% 
  mutate(`Bottom-Right`=0) %>% 
  gather("Behavior", "n_prime", 5:17)

ag_zeros <- left_join(zeromatrix, ag2, by=(c("Opponent.1", "Sex", "dom_status_ds", "Cage", "Behavior")))
ag_zeros[is.na(ag_zeros)]<-0

ag3 <- ag_zeros %>% 
  filter(Behavior!="Top-Right") %>% 
  filter(Behavior!="Top-Left") %>% 
  filter(Behavior!="Bottom-Right") %>% 
  filter(Behavior!="Bottom-Left")

ag4 <- ag3 %>% 
  filter(Behavior=="Induced Flee") %>% 
  mutate(Behavior="Induced \nFlee")

ag5 <- ag3 %>% 
  filter(Behavior!="Induced Flee")

ag3 <- rbind(ag4, ag5)

ag3$Behavior <- factor(ag3$Behavior, levels=c("Chasing", "Mounting", "Attacking", "Stealing", "Fleeing", "Induced \nFlee", "Freeze", "Unseen", "Inactive"))
```


```{r dom off vs sub def}
off <- c("Chasing", "Attacking", "Mounting", "Stealing")
def <- c("Fleeing", "Induced \nFlee", "Freeze")

ag_dom <- ag3 %>% 
  filter(Behavior %in% off) %>% 
  filter(dom_status_ds=="Dominant") %>% 
  group_by(Cage, Sex) %>% 
  summarise(dom_off_n=sum(n))

ag_sub <- ag3 %>% 
  filter(Behavior %in% def) %>% 
  filter(dom_status_ds=="Subordinate") %>% 
  group_by(Cage, Sex) %>% 
  summarise(sub_def_n=sum(n))

ag_domsub <- left_join(ag_dom, ag_sub, by=c("Cage", "Sex"))

ag_domsub2 <- gather(ag_domsub, "group", "n", 3:4)

ggplot(ag_domsub2, aes(group, n, group=Cage)) +
  geom_point()+
  geom_line()


```


##Group Size Effects, Males
```{r}
grpsize_male <- ag %>% 
  filter(Sex=="M")

grpsize_male <- grpsize_male %>% 
  group_by(Cage, Opponent.1, GrpSize, dom_status_ds, Behavior) %>% 
  count(value)

zeromatrix <- ag %>%
  filter(Sex=="M") %>% 
  filter(Age=="Young") %>% 
  select(Opponent.1, GrpSize, dom_status_ds, Cage) %>% 
  unique() %>% 
  mutate(Chasing=0) %>% 
  mutate(Mounting=0) %>% 
  mutate(Attacking=0) %>% 
  mutate(Stealing=0) %>% 
  mutate(Fleeing=0) %>% 
  mutate(`Induced Flee`=0) %>%
  mutate(Freeze=0) %>% 
  mutate(Unseen=0) %>% 
  mutate(Inactive=0) %>% 
  mutate(`Top-Left`=0) %>% 
  mutate(`Top-Right`=0) %>% 
  mutate(`Bottom-Left`=0) %>% 
  mutate(`Bottom-Right`=0) %>% 
  gather("Behavior", "n_prime", 5:17)

grpsize_zeros <- left_join(zeromatrix, grpsize_male, by=(c("Opponent.1", "GrpSize","dom_status_ds", "Cage", "Behavior")))
grpsize_zeros[is.na(grpsize_zeros)]<-0

grpsize_ag <- grpsize_zeros %>% 
  filter(Behavior!="Top-Right") %>% 
  filter(Behavior!="Top-Left") %>% 
  filter(Behavior!="Bottom-Right") %>% 
  filter(Behavior!="Bottom-Left")

grpsize_ag1 <- grpsize_ag %>% 
  filter(Behavior=="Induced Flee") %>% 
  mutate(Behavior="Induced \nFlee")

grpsize_ag2 <- grpsize_ag %>% 
  filter(Behavior!="Induced Flee")

grpsize_ag <- rbind(grpsize_ag1, grpsize_ag2)

grpsize_ag$Behavior <- factor(grpsize_ag$Behavior, levels=c("Chasing", "Mounting", "Attacking", "Stealing", "Fleeing", "Induced \nFlee", "Freeze", "Unseen", "Inactive"))
```

```{r}
#subset out dominants
grpsize_dom <- filter(grpsize_ag, dom_status_ds=="Dominant")

off <- c("Chasing", "Attacking", "Mounting", "Stealing")
def <- c("Fleeing", "Induced Flee", "Freeze")

grpsizeplot <- ggplot(grpsize_dom, aes(Behavior, n, fill=as.factor(GrpSize)))+
  geom_boxplot()+
  xlab("")+
  scale_fill_npg()
grpsizeplot
```

```{r}

grpsize_dom$GrpSize <- as.factor(grpsize_dom$GrpSize)

grpsize_dom_off <- filter(grpsize_dom, Behavior %in% off)

dom_grpsize_mdl_off <- lm(n~Behavior + GrpSize + Behavior*GrpSize, data=grpsize_dom_off)

anova(dom_grpsize_mdl_off)
summary(dom_grpsize_mdl_off)


```

#Age effects, Female
```{r}
age_female <- ag %>% 
  filter(Sex=="F")

age_female <- age_female %>% 
  group_by(Cage, Opponent.1, Age, Behavior) %>% 
  count(value)

zeromatrix <- ag %>%
  filter(Sex=="F") %>% 
  select(Opponent.1, Age, Cage) %>% 
  unique() %>% 
  mutate(Chasing=0) %>% 
  mutate(Mounting=0) %>% 
  mutate(Attacking=0) %>% 
  mutate(Stealing=0) %>% 
  mutate(Fleeing=0) %>% 
  mutate(`Induced Flee`=0) %>%
  mutate(Freeze=0) %>% 
  mutate(Unseen=0) %>% 
  mutate(Inactive=0) %>% 
  mutate(`Top-Left`=0) %>% 
  mutate(`Top-Right`=0) %>% 
  mutate(`Bottom-Left`=0) %>% 
  mutate(`Bottom-Right`=0) %>% 
  gather("Behavior", "n_prime", 4:16)

age_zeros <- left_join(zeromatrix, age_female, by=(c("Opponent.1", "Age", "Cage", "Behavior")))
age_zeros[is.na(age_zeros)]<-0

age_ag <- age_zeros %>% 
  filter(Behavior!="Top-Right") %>% 
  filter(Behavior!="Top-Left") %>% 
  filter(Behavior!="Bottom-Right") %>% 
  filter(Behavior!="Bottom-Left")

age_ag1 <- age_ag %>% 
  filter(Behavior=="Induced Flee") %>% 
  mutate(Behavior="Induced \nFlee")

age_ag2 <- age_ag %>% 
  filter(Behavior!="Induced Flee")

age_ag <- rbind(age_ag1, age_ag2)

age_ag$Behavior <- factor(age_ag$Behavior, levels=c("Chasing", "Mounting", "Attacking", "Stealing", "Fleeing", "Induced \nFlee", "Freeze", "Unseen", "Inactive"))


age_plot <- ggplot(age_ag, aes(Behavior, n, fill=Age))+
  geom_boxplot()+
  xlab("")+
  scale_fill_npg()+
  theme(axis.text.x = element_text(angle = -45, hjust=-.025))

age_plot
```

```{r grouped plot}
fig3 <- plot_grid(
  sexplot, grpsize_plot, age_plot,
  labels = "AUTO", ncol = 1
)

ggsave("/Users/justinvarholick/Documents/GitHub/AcomysDominance_2022_Data_Results/R generated figures/Fig3_socbhv_plots.tiff", fig3, units="cm", width = 15, height = 15, device='tiff', dpi=300)

  fig3
```

